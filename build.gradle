/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'java'
}

java.sourceCompatibility = JavaVersion.VERSION_17

import java.nio.file.Files
import java.nio.file.StandardCopyOption


def downloadsBase = new File(gradle.gradleUserHomeDir, "caches/downloads")
def ditaOtVersion = project.property("ditaOtVersion")
def ditaOtCacheDir = new File(downloadsBase, "dita")
def ditaOtFileName = "dita-ot-${ditaOtVersion}"
def ditaOtZip = new File(ditaOtCacheDir, "${ditaOtFileName}.zip")
def ditaOtDir = file("${buildDir}/${ditaOtFileName}")
def ditaPluginSrcDir = file("src/main/plugin")
def ditaPluginTargetDir = file("${ditaOtDir}/plugins/${project.name}")
def xspecTestsDir = file("src/test/xspec")
def xspecTests = fileTree(xspecTestsDir) {
    include "**/*.xspec"
    exclude "**/*.module.xspec"
}
def xspecResultDir = file("${buildDir}/xspec")
def ditaProjectFile = file("dita-project.xml")
def ditaOutputDir = file("${buildDir}/out")
def ditaSourceDir = file("src/main/content")
def xspecVersion = project.property("xspecVersion")
def xspecCacheDir = new File(downloadsBase, "xspec")
def xspecFileName = "xspec-${xspecVersion}"
def xspecZip = new File(xspecCacheDir, "${xspecFileName}.zip")
def xspecDir = file("${buildDir}/${xspecFileName}")
def xspecBin = file("${xspecDir}/bin/xspec.sh")
def saxonVersion = project.property("saxonVersion")
def saxonCacheDir = new File(downloadsBase, "saxon")
def saxonZip = new File(saxonCacheDir, "SaxonHE${saxonVersion}J.zip")
def saxonDir = file("${buildDir}/saxon-${saxonVersion}")

tasks.register("downloadXSpec") {
    inputs.property "xspecVersion", xspecVersion
    outputs.file xspecZip

    xspecCacheDir.mkdirs()
    if (!xspecZip.exists()) {
        def url = new URL("https://github.com/xspec/xspec/archive/refs/tags/v${xspecVersion}.zip")
        url.withInputStream { stream ->
            Files.copy(stream, xspecZip.toPath(), StandardCopyOption.REPLACE_EXISTING)
        }
    }
}

tasks.register("unpackXSpec", Copy) {
    dependsOn "downloadXSpec"
    from(zipTree(xspecZip)) {
        eachFile { fileCopyDetails ->
            def segments = fileCopyDetails.relativePath.segments
                fileCopyDetails.relativePath = new RelativePath(true, *segments.drop(1))
        }
    }
    into xspecDir
    inputs.file xspecZip
    outputs.dir xspecDir
}


tasks.register("downloadSaxon") {
    inputs.property "saxonVersion", saxonVersion
    outputs.file saxonZip
    saxonCacheDir.mkdirs()
    if (!saxonZip.exists()) {
        def url = new URL("https://github.com/Saxonica/Saxon-HE/releases/download/SaxonHE${saxonVersion}/SaxonHE${saxonVersion}J.zip")
        url.withInputStream { stream ->
            Files.copy(stream, saxonZip.toPath(), StandardCopyOption.REPLACE_EXISTING)
        }
    }
}

tasks.register("unpackSaxon", Copy) {
    dependsOn "downloadSaxon"
    from zipTree(saxonZip)
    into saxonDir
    inputs.file saxonZip
    outputs.dir saxonDir
}

tasks.register('downloadDitaOt') {
    inputs.property "ditaOtVersion", ditaOtVersion
    outputs.file ditaOtZip
    ditaOtCacheDir.mkdirs()
    if (!ditaOtZip.exists()) {
        def url = new URL("https://github.com/dita-ot/dita-ot/releases/download/${ditaOtVersion}/dita-ot-${ditaOtVersion}.zip")
        url.withInputStream { stream ->
            Files.copy(stream, ditaOtZip.toPath(), StandardCopyOption.REPLACE_EXISTING)
        }
    }
}

tasks.register('unpackDitaOt', Copy) {
    dependsOn 'downloadDitaOt'
    from(zipTree(ditaOtZip)) {
        eachFile { fileCopyDetails ->
            def segments = fileCopyDetails.relativePath.segments
                fileCopyDetails.relativePath = new RelativePath(true, *segments.drop(1))
        }
    }
    into ditaOtDir
    inputs.file ditaOtZip
    outputs.dir ditaOtDir
}

tasks.register('copyPluginToDitaOt', Copy) {
    dependsOn 'unpackDitaOt'
    from ditaPluginSrcDir
    into ditaPluginTargetDir
    inputs.dir ditaPluginSrcDir
    outputs.dir ditaPluginTargetDir
}

tasks.register('ditaInstall', Exec) {
    dependsOn 'copyPluginToDitaOt'
    inputs.dir ditaPluginTargetDir
    outputs.file file("${ditaOtDir}/.installed")

    workingDir ditaOtDir
    commandLine "bash", "-c", "${ditaOtDir}/bin/dita install > ${ditaOtDir}/.installed"
}

tasks.register('runDitaProjectCv', Exec) {
    dependsOn 'ditaInstall'
    inputs.file ditaProjectFile
    inputs.dir ditaPluginTargetDir
    inputs.files fileTree(ditaSourceDir) {
        include 'main.ditamap'
        include 'keys.ditamap'
        include 'related-links.dita'
        include 'cv.dita'
        include 'cv_content.dita'
        include 'profile_picture.png'
        include 'profile.jpg'
    }
    outputs.dir ditaOutputDir
    outputs.file file("${ditaOutputDir}/cv.pdf")

    commandLine "${ditaOtDir}/bin/dita", 
                "--project=${ditaProjectFile}",
                "--deliverable=cv",
                "--output=${buildDir}/out"
}

tasks.register('runDitaProjectCoverLetter', Exec) {
    dependsOn 'ditaInstall'
    inputs.file ditaProjectFile
    inputs.dir ditaPluginTargetDir
    inputs.files fileTree(ditaSourceDir) {
        include 'main.ditamap'
        include 'keys.ditamap'
        include 'related-links.dita'
        include 'cover_letter.dita'
        include 'cover_letter_content.dita'
    }
    outputs.dir ditaOutputDir
    outputs.file file("${ditaOutputDir}/cover_letter.pdf")

    commandLine "${ditaOtDir}/bin/dita", 
                "--project=${ditaProjectFile}",
                "--deliverable=cover_letter",
                "--output=${buildDir}/out"
}

tasks.register('runDitaProject') {
    dependsOn 'runDitaProjectCv', 'runDitaProjectCoverLetter'
}

xspecTests.each { xspecFile ->
    def baseName = xspecFile.name.replaceFirst(/\.xspec$/, "")
    def htmlOut = new File(xspecResultDir, "${baseName}-result.html")
    def junitOut = new File(xspecResultDir, "${baseName}-junit.xml")

    tasks.register("runXSpec_${baseName}", Exec) {
        group = "verification"
        inputs.dir xspecTestsDir
        outputs.files htmlOut, junitOut
        dependsOn "unpackXSpec"

        environment "SAXON_HOME", saxonDir.absolutePath
        environment "TEST_DIR", "${buildDir}/xspec"
        commandLine xspecBin.absolutePath, "-j",
            xspecFile.absolutePath
    }
}

tasks.register("runXSpec") {
    group = "verification"
    description = "Run all XSpec tests"
    dependsOn "unpackXSpec", "unpackSaxon", tasks.matching { it.name.startsWith("runXSpec_") }
}

tasks.register('packagePlugin', Zip) {
    dependsOn 'runXSpec'
    from ditaPluginSrcDir
    archiveFileName.set("${project.name}.zip")
    destinationDirectory.set(file("${buildDir}/dist"))
}

tasks.register('prepareDitaOt') {
    dependsOn 'ditaInstall'
}

tasks.register('runBuild') {
    dependsOn 'runDitaProject', 'runXSpec', 'packagePlugin'
}
